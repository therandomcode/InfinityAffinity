<!DOCTYPE html><html lang='en' class=''>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<head>
	<!--Let's import all the libraries we need -->
	<link rel = "stylesheet" type = "text/css" href = "style.css" />
	<script type='text/javascript' src="import.js"></script>
	<script type='text/javascript' src="view-handler.js"></script>
	<script type='text/javascript' src="process-text.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
</head>

<body>
	<div id="getting-started">
		<h2>Choose the .CSV file you want to sort through</h2>
			<p>I know how to parse HotJar and FreshDesk files.</p>
		<div id = "initial-input">
			<input id="upload-file" type="file"/>
			<br>
			<button id = "submit-file" onclick="init()">Upload</button>
		</div>
	</div>

<!--<div id="add-more-files">
	<div id = "another-input">
		<input id="upload-another-file" type="file"/>
		<button id = "submit-another-file">Upload Another</button>
	</div>
</div>--> 

<script> 
buckets = [];
currentModel = []; 

function init(){
    console.log("parseFile started");
    var bigFile = document.getElementById("upload-file").files[0]; 

	var stacks = parseFile(bigFile, buckets);
	if (stacks == -1){
		return; 
	}
	console.log("We finished executing parseFile()");
}

function parseFile(file, buckets){ 
	buckets[0] = []; 
	var count = 0; 
	var whichSource = "none"; 
	Papa.parse(file, {
	header: true,
	step: function(row) {
		// First, let's figure out if this is HotJar. We only run this check on the first entry. 	
		if (count == 0){
			console.log("Here is the data we are looking at", row.data[0]);
			/* If this is a HotJar .CSV */
			if 
				('Browser' in row.data[0] 
				&& 'Country' in row.data[0] 
				&& 'Date Submitted' in row.data[0]
				&& 'Device' in row.data[0]
				&& 'Email' in row.data[0]
				&& 'Message' in row.data[0])
			{
				whichSource = "hj";
			}
			/* If this is a FreshDesk .CSV */
			else if (
				'Ticket ID' in row.data[0]
				&& 'Subject' in row.data[0]
				&& 'Created time' in row.data[0] 
				&& 'Source' in row.data[0] 
				&& 'Description' in row.data[0])
			{
				whichSource = "fd";
			}
			else {
				console.log("This doesn't look like a CSV I know or understand yet");
			}
		}
		count++; 
		if (whichSource == "hj"){
			console.log("This is a hotjar document");
			if (row.data[0]["Message"] != undefined && isMinimallyInteresting(row.data[0]["Message"])){
				var newcard = new Card(
				trimMessage(row.data[0]["Message"]), //message field
				row.data[0]["Date Submitted"], //time
				"HotJar",
				deSmallpdf(row.data[0]["Source URL"]),//tag
				"",
				count //id
			);
			buckets[0].push(newcard);
			}
		}
        else if (whichSource == "fd"){
			console.log("This is a freshdesk document");
			if (row.data[0]["Description"] != undefined && isMinimallyInteresting(row.data[0]["Description"])){
				var newcard = new Card(
				trimMessage(row.data[0]["Description"]), //message field
				row.data[0]["Created Time"], //time
				"FreshDesk",
				row.data[0]["Tags"],//tag
				"",
				count //id
			);
			buckets[0].push(newcard);
			}
		}
	},
	complete: function() {
		console.log("All done!");
				drawSortingScreen(); 
		if (buckets.size == 0){
			if (whichSource == "none"){
				document.getElementById("getting-started").innerHTML += '<div class="error">This doesnt look like a CSV I know or understand yet. Try again :( </div>';
				return -1; 
			} else {
				//draw onboarding instructions
			}
		}
	}
});
return buckets[0];
}

function showBuckets(){
	console.log(buckets); 
}

</script>
</body>
</html>