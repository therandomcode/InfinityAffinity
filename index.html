<!DOCTYPE html><html lang='en' class=''>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<head>
	<!--Let's import all the libraries we need -->
	<link rel = "stylesheet" type = "text/css" href = "style.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
	<script type='text/javascript' src="import.js"></script>
	<script type='text/javascript' src="view-handler.js"></script>
	<script type='text/javascript' src="process-text.js"></script>
</head>

<body>
	<div id = "logo">
		<h1>Affinity CSV</h1>
	</div>
	<div id="getting-started">
		<!--<h2>Choose the .CSV file you want to sort through</h2>--> 
		<p>I know how to parse HotJar and FreshDesk files.</p><br>
			<input type="file" name="upload-file" id="upload-file" class="inputfile"/>
			<label for="upload-file" id="submit-file">Upload CSV</label></input>
		</div>
	</div>

	<div id = "madeWithLove">

		<p><a onclick = "about()">About</a></p>
		<p2>Made with <span style="font-size:12px; font-weight:bold; color:#990000ee;">â™¥</span> for the people of the internet by <a href = "https://www.kristinawagner.website">Kristina Wagner</a></div>
		</p2>
<input type="file" name="file" id="file" class="inputfile"/>
<label for="file" id = "add-more">+</label></input>

<script> 
buckets = [];
currentModel = []; 

window.onbeforeunload = function(){
	if (document.getElementById("bucket1")){
 		return 'Are you sure you want to leave?';
	}
};

	document.getElementById("upload-file").addEventListener("change", function(){
		console.log("Trying to add a file!"); 
		init(); 
	});

function init(){
    console.log("parseFile started");
	var bigFile = document.getElementById("upload-file").files[0]; 
	console.log(bigFile); 
	console.log("That was our first file"); 

	var stacks = parseFile(bigFile, buckets);
	if (stacks == -1){
		return; 
	}

	document.getElementById("file").addEventListener("change", function(){
		console.log("Trying to add another file!"); 
		var anotherFile = document.getElementById("file").files[0]; 
		console.log("anotherFile", anotherFile); 
		parseFile(anotherFile, generateModel);
	});
	console.log("We finished executing parseFile()");
}

function parseFile(file, buckets){ 
	buckets[0] = []; 
	var count = 0; 
	var whichSource = "none"; 
	Papa.parse(file, {
	header: true,
	step: function(row) {
		// First, let's figure out if this is HotJar. We only run this check on the first entry. 	
		if (count == 0){
			console.log("Here is the data we are looking at", row.data[0]);
			/* If this is a HotJar .CSV */
			if 
				('Browser' in row.data[0] 
				&& 'Country' in row.data[0] 
				&& 'Date Submitted' in row.data[0]
				&& 'Device' in row.data[0]
				&& 'Email' in row.data[0]
				&& 'Message' in row.data[0])
			{
				whichSource = "hj";
			}
			/* If this is a FreshDesk .CSV */
			else if (
				'Ticket ID' in row.data[0]
				&& 'Subject' in row.data[0]
				&& 'Created time' in row.data[0] 
				&& 'Source' in row.data[0] 
				&& 'Description' in row.data[0])
			{
				whichSource = "fd";
			}
			else {
				console.log("This doesn't look like a CSV I know or understand yet");
			}
		}
		count++; 
		if (whichSource == "hj"){
			console.log("This is a hotjar document");
			if (row.data[0]["Message"] != undefined && isMinimallyInteresting(row.data[0]["Message"])){
				var newcard = new Card(
				trimMessage(row.data[0]["Message"]), //message field
				row.data[0]["Date Submitted"], //time
				"HotJar",
				deSmallpdf(row.data[0]["Source URL"]),//tag
				"",
				count //id
			);
			console.log(newcard.date); 
			buckets[0].push(newcard);
			}
		}
        else if (whichSource == "fd"){
			console.log("This is a freshdesk document");
			console.log(row.data[0]["Tags"]); 
			if (row.data[0]["Description"] != undefined && isMinimallyInteresting(row.data[0]["Description"])){
				var newcard = new Card(
				trimMessage(row.data[0]["Description"]), //message field
				row.data[0]["Created time"], //date
				"FreshDesk", // source
				"", // url
				row.data[0]["Tags"],//tag
				count //id
			);
			buckets[0].push(newcard);
			}
		}
	},
	complete: function() {
		console.log("All done!");
				drawSortingScreen(); 
		if (buckets.size == 0){
			if (whichSource == "none"){
				document.getElementById("getting-started").innerHTML += '<div class="error">This doesnt look like a CSV I know or understand yet. Try again :( </div>';
				return -1; 
			} else {
				//draw onboarding instructions
			}
		}
	}
});
return buckets[0];
}

function showBuckets(){
	console.log(buckets); 
}


</script>
</body>
</html>