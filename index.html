<!DOCTYPE html><html lang='en' class=''>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<head>
	<!--Let's import all the libraries we need -->
	<link rel = "stylesheet" type = "text/css" href = "style.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
	<script type='text/javascript' src="import.js"></script>
	<script type='text/javascript' src="view-handler.js"></script>
	<script type='text/javascript' src="process-text.js"></script>
</head>

<body>
	<div id = "logo">
		<h1>Affinity CSV</h1>
	</div>
	<div id="getting-started">
		<p>I know how to parse HotJar and FreshDesk files.</p><br>
			<input type="file" name="upload-file" id="upload-file" class="inputfile"/>
			<label for="upload-file" id="submit-file">Upload CSV</label></input>
		</div>
	</div>

	<div id = "madeWithLove">
		<p><a onclick = "about()">About</a></p>
		<p2>Made with <span style="font-size:12px; font-weight:bold; color:#990000ee;">â™¥</span> for the people of the internet by <a href = "https://www.kristinawagner.website">Kristina Wagner</a>
		</p2></div>
<input type="file" name="file" id="file" class="inputfile"/>
<label for="file" id = "add-more">+</label></input>

<script> 

window.onbeforeunload = function(){
	if (document.getElementById("bucket1")){
 		return 'Are you sure you want to leave?';
	}
};

document.getElementById("upload-file").addEventListener("change", function(){
	console.log("Trying to add a file!"); 
	init(); 
});

function init(){
    console.log("parseFile started");
	var bigFile = document.getElementById("upload-file").files[0]; 
	console.log(bigFile); 
	console.log("That was our first file"); 

	var stacks = parseFile(bigFile);
	if (stacks == -1){
		return; 
	}

	document.getElementById("file").addEventListener("change", function(){
		console.log("Trying to add another file!"); 
		var anotherFile = document.getElementById("file").files[0]; 
		console.log("anotherFile", anotherFile); 
		parseFile(anotherFile, generateModel);
	});
	console.log("We finished executing parseFile()");
}

function parseFile(file){ 
	var count = 0; 
	var message = "";
	var time = "";
	var source = "";
	var tags = "";
	var url = ""; 

	var whichSource = "none"; 
	Papa.parse(file, {
	header: true,
	preview: 1,
	step: function(row) {
		// First, let's figure out if this is HotJar. We only run this check on the first entry. 	
		if (count === 0){
			//
			
			
			console.log("Here is the data we are looking at", row.data[0]);
			/* If this is a HotJar .CSV */
			if ('Browser' in row.data[0] 
				&& 'Country' in row.data[0] 
				&& 'Date Submitted' in row.data[0]
				&& 'Device' in row.data[0]
				&& 'Email' in row.data[0]
				&& 'Message' in row.data[0])
				{
					whichSource = "hj";
					//console.log("This is a hotjar document");
					message = "Message"; 
					time = "Date Submitted";
					source = "HotJar"; 
					tags = ""
					url = "Source URL"; 
					parseWholeFile(file, message, time, source, tags, url); 
				}
			/* If this is a FreshDesk .CSV */
			else if (
				'Ticket ID' in row.data[0]
				&& 'Subject' in row.data[0]
				&& 'Created time' in row.data[0] 
				&& 'Source' in row.data[0] 
				&& 'Description' in row.data[0])
				{
					whichSource = "fd";
					//console.log("This is a freshdesk document");
					message = "Description"; 
					time = "Created time";
					source = "FreshDesk"; 
					tags = "Tags";
					url = ""; 
					parseWholeFile(file, message, time, source, tags, url); 
				}
			else {
				drawSelectionModal(Object.keys(row.data[0]), file); 
			}
			count++;
			//console.log(count);  
		}
	},
	complete: function() {
		console.log("All done!");
	}
});
}


function parseWholeFile(file, message, time, source, tags, url){ 
	var newCardsList = [];  
	Papa.parse(file, {
	header: true,
	step: function(row) {
		//console.log(row.data[0][message]);
		if (row.data[0][message] != undefined && isMinimallyInteresting(row.data[0][message])){
				var newcard = addCard(row.data[0], message, time, source, tags, url); 
				newCardsList.push(newcard);
			}
	},
	complete: function() {
		console.log("All done!");
		drawSortingScreen(newCardsList); 
	}
});
}

function addCard(data, message, time, source, tags, url, uniqueid, count){
	var extractedTags = "";
	if (typeof data[tags] === 'string'){
		extractedTags = data[tags];
	} else {	
		for (var i = 0; i < tags.length; i++){
			var tempTag = data[tags[i]];  
			tempTag = cleanSmallpdfUrl(tempTag);
			if (isInterestingTag(tempTag)){
				extractedTags += tempTag; 
				extractedTags += ", ";  
			}
		}
		extractedTags = extractedTags.slice(0, -2); // remove last comma
	}

	function cleanSmallpdfUrl(str){
		return str.replace("https://smallpdf.com/",'');
	}
	function isInterestingTag(str){
		str = str.replace(/\s+/g,' '); 
		if ( str != ""
		&& str.replace(" ", "") != ""
		&& str.length < 40
		&& str.length > 4
		&& (str.indexOf('@') < 0)
		&& (str.replace(/\d/g, "").length > 0) // string is not entirely numbers
		&& str != "other"
		&& str != "No company"
		&& str != "Closed"
		&& str != "general"
		&& str != "No Group"
		){
			return true;
		} else {
			return false; 
		}
	}

	//console.log("In add card: ", data[message]); 
		var newcard = new Card(
		trimMessage(data[message]), //message field
		data[time], //date
		source, // source
		url, // url
		extractedTags, // actual tags, as a comma-separated string
		String( Math.floor((Math.random() * 1000000) + 1)), //generate a random ID //id
	);
	return newcard; 
}


</script>
</body>
</html>